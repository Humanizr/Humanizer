const fs = require('fs');
const path = require('path');

function loadManifest() {
  const manifestPath = path.join(__dirname, 'api-docs', 'versions.json');
  const templatePath = path.join(__dirname, 'src', 'data', 'apiVersionDefaults.js');
  try {
    if (fs.existsSync(manifestPath)) {
      return JSON.parse(fs.readFileSync(manifestPath, 'utf-8'));
    }
  } catch (error) {
    console.warn('Unable to read API versions manifest, falling back to template.', error);
  }

  if (fs.existsSync(templatePath)) {
    // eslint-disable-next-line global-require
    return require(templatePath);
  }

  return {
    defaultSlug: 'dev',
    releases: [],
    development: {label: 'Latest dev (main)', slug: 'dev'}
  };
}

const manifest = loadManifest();

const apiSidebar = [
  {
    type: 'doc',
    id: 'index',
    label: 'Overview'
  }
];

manifest.releases.forEach(release => {
  apiSidebar.push({
    type: 'category',
    label: `Release ${release.label}`,
    collapsed: manifest.defaultSlug !== release.slug,
    items: [
      {
        type: 'autogenerated',
        dirName: release.slug
      }
    ]
  });
});

apiSidebar.push({
  type: 'category',
  label: manifest.development.label,
  collapsed: manifest.defaultSlug !== manifest.development.slug,
  items: [
    {
      type: 'autogenerated',
      dirName: manifest.development.slug
    }
  ]
});

module.exports = {
  apiSidebar
};
